name: Run flake checks

on:
  push:
    branches:
      - master
  pull_request: {}

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install nix ‚ùÑÔ∏è
        uses: cachix/install-nix-action@v16

      - name: Run checks ‚úÖ
        run: nix flake check

      - name: Check Conventional Commits üìù
        uses: webiny/action-conventional-commits@v1.0.5

  build:
    strategy:
      matrix:
       os:
         - ubuntu-latest
         - macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install nix ‚ùÑÔ∏è
        uses: cachix/install-nix-action@v16

      - name: Build üõ†Ô∏è
        id: build
        run: |
          export SYSTEM=$(nix eval --impure --raw --expr "builtins.currentSystem")
          echo "::set-output name=system::$SYSTEM"
          nix build ".#buildJobs.${SYSTEM}.combined" -vL
          echo "::set-output name=result::$(readlink result)"

      - name: Upload result
        uses: actions/upload-artifact@v3
        with:
          name: result-${{ steps.build.outputs.system }}
          path: ${{ steps.build.outputs.result }}

